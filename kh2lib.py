ALL_ABILITIES_CODE = """
1032E074 00000052
1032E076 00000089
1032E078 0000010F
1032E07A 0000010B
1032E07C 00000111
1032E07E 00000106
1032E080 00000107
1032E082 0000022F
1032E084 00000108
1032E086 00000232
1032E088 00000109
1032E08A 0000010A
1032E08C 0000010D
1032E08E 00000230
1032E090 0000010E
1032E092 00000110
1032E094 00000231
1032E096 0000010C
1032E098 00000181
1032E09A 00000182
1032E09C 00000238
1032E09E 00000183
1032E0A0 00000184
1032E0A2 00000185
1032E0A4 000000C6
1032E0A6 0000008A
1032E0A8 0000021B
1032E0AA 000000A2
1032E0AC 000000A2
1032E0AE 000000A3
1032E0B0 000000A3
1032E0B2 00000186
1032E0B4 00000187
1032E0B6 00000188
1032E0B8 00000189
1032E0BA 0000018A
1032E0BC 0000018B
1032E0BE 0000018C
1032E0C0 0000018D
1032E0C2 0000018E
1032E0C4 0000018E
1032E0C6 0000018F
1032E0C8 00000190
1032E0CA 00000191
1032E0CC 00000192
1032E0CE 00000193
1032E0D0 00000195
1032E0D2 00000195
1032E0D4 00000196
1032E0D6 00000197
1032E0D8 0000021C
1032E0DA 00000198
1032E0DC 00000199
1032E0DE 0000019A
1032E0E0 0000019B
1032E0E2 0000019C
1032E0E4 0000019D
1032E0E6 0000019E
1032E0E8 0000021E
1032E0EA 0000019F
1032E0EC 000001A0
1032E0EE 00000060
1032E0F0 00000064
1032E0F2 00000236
1032E0F4 00000068
1032E0F6 0000006C
1032E0F8 00000188
1032E0FA 00000189
1032E0FC 00000195
1032E0FE 00000197
1032E100 00000197
1032E102 000001A5
1032E104 00000194
0032E028 000000DD
1032E188 000000A5
1032E18A 000000A6
1032E18C 000000A7
1032E18E 000000A8
1032E190 000000C7
1032E192 000000C8
1032E194 00000195
1032E196 00000196
1032E198 00000197
1032E19A 00000198
1032E19C 00000199
1032E19E 0000019A
1032E1A0 0000019C
1032E1A2 000001A5
1032E1A4 000001A1
1032E1A6 000001A3
1032E1A8 000001A4
0032E13C 00000030
1032E29C 000001A7
1032E29E 000001AD
1032E2A0 000001A9
1032E2A2 000000C9
1032E2A4 000000CA
1032E2A6 00000195
1032E2A8 00000196
1032E2AA 00000197
1032E2AC 0000019B
1032E2AE 0000019C
1032E2B0 0000019E
1032E2B2 0000021E
1032E2B4 0000019F
1032E2B6 000001A0
1032E2B8 000001A1
1032E2BA 000001A2
1032E2BC 000001A3
1032E2BE 000001A4
0032E250 00000035
21D10CB8 00000000
21D11278 00000000
21D10DF8 00000000
21D108C8 00000000
21D108E8 00000000
21D10758 00000000
21D10768 00000000
21D10968 00000000
21D10788 00000000
21D10808 00000000
21D10FE8 00000000
21D11008 00000000
21D10828 00000000
21D10848 00000000
21D10D28 00000000
21D10988 00000000
11D10998 00000000
11D1099A 00000000
21D109D8 00000000
21D110B8 00000000
21D110C8 00000000
21D10D58 00000000
21D10AA8 00000000
11D10AC8 00000000
11D10ACA 00000000
21D10DB8 00000000
21D10DC8 00000000
21D10E78 00000000
21D10CE8 00000000
21D109E8 00000000
21D109F8 00000000
21D10A48 00000000
21D10EC8 00000000
21D10BE8 00000000
21D10E28 00000000
21D10C38 00000000
21D10C58 00000000
21D10BB8 00000000
21D11068 00000000
21D10928 00000000
21D107D8 00000000
21D10888 00000000
21D11028 00000000
21D11048 00000000
21D10AF8 00000000
21D10D98 00000000
21D10A78 00000000
21D10EF8 00000000
21D11078 00000000
21D11088 00000000
21D10FC8 00000000
21D110E8 00000000
21D111E8 00000000
21D11178 00000000
11D1A22E 00000000
11D1A23E 00000000
11D1A24E 00000000
11D1A266 00000000
11D1A276 00000000
11D1A286 00000000
11D1A29E 00000000
11D1A2AE 00000000
11D1A2BE 00000000
11D1A2D6 00000000
11D1A2E6 00000000
11D1A2F6 00000000
11D1A30E 00000000
11D1A31E 00000000
11D1A32E 00000000
"""
INF_HP_CODE = """
200FE000 8C820004
200FE004 0806891E
200FE008 AC820000
20166CD8 0C03F800
"""
R2_UNLOCK_DRIVES_CODE = """
E006FDFF 0034d3c0
2032F1F0 FFFFFFFF
2032F1F4 FFFFFFFF
2032F1F8 FFFFFFFF
1032EE24 00000029
1032EECC 00000029
1032EF04 00000029
"""
HAVE_ALL_ITEMS_CODE = """
4032F0B0 00060001
0A0A0A0A 00000000
0032F0C9 0000000A
1032F0CA 00000A0A
4032F0CC 00020001
0A0A0A0A 00000000
1032F0D6 00000A0A
1032F0D8 00000A0A
1032F0DC 00000A0A
1032F0E0 00000A0A
0032F0E2 0000000A
0032F0E7 0000000A
1032F0E8 00000A0A
1032F0EA 00000A0A
1032F0EC 00000A0A
0032F0EE 0000000A
0032F0F3 0000000A
2032F0F4 0A0A0A0A
1032F0FA 00000A0A
4032F0FC 000B0001
0A0A0A0A 00000000
1032F128 00000A0A
0032F12B 0000000A
4032F12C 00100001
0A0A0A0A 00000000
0032F17B 0000000A
2032F17C 0A0A0A0A
0032F181 00000000A
4032F194 000200001
0A0A0A0A 00000000
1032F19C 00000A0A
0032F1AB 0000000A
4032F1AC 00060001
0A0A0A0A 00000000
4032F1C8 00060001
0A0A0A0A 00000000
1032F1E0 00000A0A
0032F1E5 0000000A
1032F1E6 00000A0A
"""
WORLDS = {
    "02": ("Twilight Town", """
E003FDFF 0034D45C
2032BAE0 0000{0}02
2032BAE4 00{1}00{1}
2032BAE8 000000{1}
"""),
    "04": ("Hollow Bastion", """
E003FDFF 0034D45C
2032BAE0 0000{00}04
2032BAE4 00{1}00{1}
2032BAE8 000000{1}
"""),
    "05": ("Beasts Castle", """
E003FDFF 0034D45C
2032BAE0 0000{0}05
2032BAE4 00{1}00{1}
2032BAE8 000000{1}
"""),
    "06": ("Olympus Colosseum", """
E003FDFF 0034D45C
2032BAE0 0000{0}06
2032BAE4 00{1}00{1}
2032BAE8 000000{1}
"""),
#uco was the only one different weird?
    "06b": ("Underdome Colosseum", """
E003FDFF 0034D45C
2032BAE0 00{1}0906
2032BAE4 00{0}00{0}
2032BAE8 000000{0}
"""),
    "07": ("Agrabah", """
E003FDFF 0034D45C
2032BAE0 0000{0}07
2032BAE4 00{1}00{1}
2032BAE8 000000{1}
"""),
    "08": ("Land of Dragons", """
E003FDFF 0034D45C
2032BAE0 0000{0}08
2032BAE4 00{1}00{1}
2032BAE8 000000{1}
"""),
    "0A": ("Pride Lands", """
E003FDFF 0034D45C
2032BAE0 0000{0}0A
2032BAE4 00{1}00{1}
2032BAE8 000000{1}
"""),
    "0C": ("Disney Castle", """
003FDFF 0034D45C
2032BAE0 0000{0}0C
2032BAE4 00{1}00{1}
2032BAE8 000000{1}
"""),
    "0D": ("Timeless River", """
E003FDFF 0034D45C
2032BAE0 0000{0}0D
2032BAE4 00{1}00{1}
2032BAE8 000000{1}
"""),
    "0E": ("Halloween Town", """
E003FDFF 0034D45C
2032BAE0 0000{0}0E
2032BAE4 00{1}00{1}
2032BAE8 000000{1}
"""),
    "10": ("Port Royal", """
E003FDFF 0034D45C
2032BAE0 0000{0}10
2032BAE4 00{1}00{1}
2032BAE8 000000{1}
"""),
    "11": ("Space Paranoids", """
E003FDFF 0034D45C
2032BAE0 0000{0}11
2032BAE4 00{1}00{1}
2032BAE8 000000{1}
"""),
    "12": ("The World That Never Was", """
E003FDFF 0034D45C
2032BAE0 0000{0}12
2032BAE4 00{1}00{1}
2032BAE8 000000{1}
""")
}
PLACEMENT_CODES = """
E0{3}{0}{1} 0032BAE0
E0{4}00{2} 0032BAE4
E0{5}00{2} 0032BAE6
E0{6}00{2} 0032BAE8
"""
ROXAS_RC_CODE = """
01C9F62F 00000001
01C9572F 00000001
"""
import csv, os, random, sys
class CodeGen:
    def __init__(self, fn="bosstable.csv", out_fn=os.path.join("cheats","F266B00B.pnach"), change_location_code=True):
        self.table = self.read_csv(fn)
        self.pnach = []
        self.out_fn=out_fn
        self.toHex = lambda b: hex(b)[2:].zfill(2).upper()
        self.change_location_code = change_location_code
    def apply_room_joker(self, codes, world, room):
        ### joker a list of codes only to be active in this room
        numcodes = hex(len(codes))[2:].zfill(2)
        return ["E0{}{}{} 0032BAEO".format(numcodes,world,room)] + codes
    def apply_event_joker(self, codes, event):
        ### joker a list of codes only to be active during this event
        return ["E0{}00{} 0032BAE4".format(self.toHex(len(codes)+2), event),
        "E0{}00{} 0032BAE6".format(self.toHex(len(codes)+1), event),
        "E0{}00{} 0032BAE8".format(self.toHex(len(codes)), event)] + codes
    def apply_ram_code(self,code_str, comment=False):
        if comment:
            self.pnach.append("// {}".format(comment))
        for line in code_str.split("\n"):
            if len(line) == 0:
                continue
            line = line.strip().split()
            self.pnach.append("patch=1,EE,{},extended,{}".format(line[0].upper(),line[1].upper()))
    def apply_boss_code(self, original, new, alt="00", replace_str=""):
        loc = original["loc"]
        obj = new["obj"]
        world = original["world"]
        room = original["room"]
        event = original["event"]
        codes = []
        codes.append("{0} 00{2}{1}".format(loc,obj,alt))
        loc2 = self.toHex(int(loc, 16)+32)
        codes.append("{0} 000000{1}".format(loc2,alt))
        codes = self.apply_room_joker(self.apply_event_joker(codes, event), world, room)
        for code in codes:
            self.apply_ram_code(code, replace_str)
            replace_str = False

    def apply_loc_code(self, location):
        world = location["world"]
        room = location["room"]
        event = location["event"]
        world_code = WORLDS[str(world)]
        if world == "06b":
            world = "06"
        printstr = "Hold R2 During transition to spawn at {} fight in {}".format(location["name"], world_code[0])
        print(printstr)
        self.apply_ram_code(world_code[1].format(room,event), printstr)
    def apply_roxas_rc_code(self):
        self.apply_ram_code(ROXAS_RC_CODE, "Roxas can perform RC's")
    def apply_all_abilities(self):
        self.apply_ram_code(ALL_ABILITIES_CODE, "Get all abilities on new game")
    def apply_inf_hp(self):
        self.apply_ram_code(INF_HP_CODE, "Have infinite HP (can still get one shot without OM/SC)")
    def apply_all_forms(self):
        self.apply_ram_code(R2_UNLOCK_DRIVES_CODE, "Hold R2 for all drives") 
    def apply_all_items(self):
        self.apply_ram_code(HAVE_ALL_ITEMS_CODE, "Get all items+Max XP on new game")
    def test(self):
        self.apply_ram_code(TEST_LOC)
    def read_csv(self, fn):
        d = {}
        with open(fn) as f:
            reader = csv.reader(f)
            i = 1
            for line in reader:
                if line[0] == 'Location Code':
                    continue
                d[i] = {"world": line[0], "room": line[1], "event": line[2], "numenemies": line[3], "loc": line[4], "obj": line[5], "name": line[6], "ttype": line[7]}
                i += 1
        return d
    def replace_boss(self, s, d):
        source = self.table[s]
        dest = self.table[d]
        obj = dest["obj"]
        if len(obj) == 6:
            alt = "01"
            dest["obj"] = obj[2:]
        else:
            alt = "00"
        replace_str = "Replacing {} with {}".format(source["name"], dest["name"])
        print(replace_str)
        self.apply_boss_code(source, dest, alt=alt, replace_str=replace_str)
        if self.change_location_code:
            self.apply_loc_code(source)
    def write_pnach(self, debug=False):
        with open(self.out_fn, "w") as f:
            for l in self.pnach:
                outstr = "{}\n".format(l)
                f.write(outstr)
                if debug:
                    print(outstr)



class Randomizer(CodeGen):
    def __init__(self, ramcode="", mapping="", helpstr="", comment="", out_fn="F266B00B.pnach"):
        super().__init__(out_fn=out_fn)
        self.mapping = mapping 
        self.ramcode = ramcode
        self.comment = comment
        self.helpstr = helpstr
        seed = self.getarg("seed") or random.randint(0,100000)
        print("Seed set to {}".format(seed))
        random.seed(seed)
        outpath = self.getarg("outpath")
        if outpath:
            print("Output changed to {}".format(outpath))
        else:
            outpath = out_fn
        self.out_fn = outpath
        

    def randomize_mapping(self, mode="normal"):
        if self.getarg("help"):
            print(self.helpstr)
            return

        replacemode = self.getarg("replacement")
        if replacemode:
            self.mode_replace(replacemode, mode)
            return
        
        self.mode_randomize(self.getarg("ignore"), mode)

    def get_random_value(self, length):
        maxval = int(''.join(['F' for f in range(length)]), 16)
        return hex(random.randint(0,maxval))[2:].upper().zfill(length)

    def randomize_value(self, length):
        if self.getarg("help"):
            print(self.helpstr)
            return
        value = self.getarg("setvalue")
        if not value:
            value = self.get_random_value(length)
        self.apply_ram_code(self.ramcode.format(value), self.comment.format(value))
        self.write_pnach()

    def randomize_choices(self):
        if self.getarg("help"):
            print(self.helpstr)
            return
        value = self.getarg("setvalue")
        if value:
            v1 = value
            v2 = value
            comment = self.comment.format(v1, v2)
        else:
            opt1 = random.choice(list(self.mapping.keys()))
            opt2 = random.choice(list(self.mapping.keys()))
            comment = self.comment.format(opt1,opt2)
            v1 = self.mapping[opt1]
            v2 = self.mapping[opt2]
        self.apply_ram_code(self.ramcode.format(v1,v2), comment)
        self.write_pnach()

    def mode_replace(self, replacemode, mode):
        for replacement in replacemode.split(","):
            things = replacement.split("->")
            if mode == "normal":
                self.applyreplacement(things[0], things[1], code=self.ramcode)
            elif mode == "models":
                self.applyreplacement(things[0], things[1], code=self.ramcode)
        self.write_pnach()

    def mode_randomize(self, ignore="", mode="normal"):
        if not ignore:
            ignore = ''
        originals = list(self.mapping.keys())
        news = list(self.mapping.keys())
        for i in ignore.split(','):
            if i in originals:
                originals.remove(i)
            if i in news:
                news.remove(i)
        random.shuffle(news)
        for o in originals:
            if mode == "normal":
                self.applyreplacement(o, news.pop(), code=self.ramcode, comment=self.comment)
            elif mode == "models":
                self.applymodelreplacement(o, news.pop(), code=self.ramcode, comment=self.comment)
            else:
                raise Exception("wrong mode")
        self.write_pnach()

    def getarg(self, v):
        for a in sys.argv:
            if a.lower().startswith(v.lower()+"="):
                return a[len(v)+1:]
        for a in os.environ:
            if a.lower().startswith("USE_KH2_{}".format(v).lower()):
                return os.environ[a]
        return None

    def applyreplacement(self, orig, new, code="{} {}", comment="{} -> {}"):
        commentout = comment.format(orig,new)
        newval = self.mapping[new][1]
        if type(newval) == tuple:
            nv1 = newval[0]
            nv2 = newval[1]
        else:
            nv1 = newval
            nv2 = ''
        if type(nv1) == int:
            # generate a hex number of that length
            nv1 = self.get_random_value(nv1)
        if type(nv2) == int:
            nv2 = self.get_random_value(nv2)
            commentout = comment.format(orig, "{},{}".format(nv1,nv2))
        self.apply_ram_code(code.format(self.mapping[orig][0], nv1, nv2), commentout)

    def applymodelreplacement(self, orig, new, code="{} {}", comment="{} -> {}"):
        # like applymodelreplacement
        # 2 lines, and the second line has an address offset 4 of the first address
        # first line is specifically 00 if turning into normal sora, and 5F if turning into form for value
        # second line is the actual value in the mapping
        comment = comment.format(orig,new)
        firstaddress = self.mapping[orig][0]
        firstvalue = "00" if new == "Sora" else "5F"
        secondaddress = hex(int(firstaddress,16)+4)[2:]
        secondvalue = self.mapping[new][1]
        self.apply_ram_code(code.format(firstaddress,firstvalue,secondaddress,secondvalue),comment)